
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mathematical details and Implementation &#8212; nway 4.7.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/jquery.js?v=5d32c60e"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="_static/documentation_options.js?v=3a5dd307"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'math';</script>
    <link rel="canonical" href="https://johannesbuchner.github.io/nway/math.html" />
    <link rel="icon" href="_static/icon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Frequently Asked Questions" href="issues.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="nway 4.7.0 documentation - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="nway 4.7.0 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="readme.html">nway</a></li>
<li class="toctree-l1"><a class="reference internal" href="getstarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="matching.html">User guide: Matching catalogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="nwayml.html">Machine learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="synopsis.html">Command line arguments</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api.html">API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="nwaylib.html">nwaylib package</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Frequently Asked Questions</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Mathematical details and Implementation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/math.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Mathematical details and Implementation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-matching">Distance-based matching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#magnitudes-colors-and-other-additional-information">Magnitudes, Colors and other additional information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#auto-calibration">Auto-calibration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="mathematical-details-and-implementation">
<span id="chap-math"></span><h1>Mathematical details and Implementation<a class="headerlink" href="#mathematical-details-and-implementation" title="Link to this heading">#</a></h1>
<section id="distance-based-matching">
<span id="sec-math"></span><h2>Distance-based matching<a class="headerlink" href="#distance-based-matching" title="Link to this heading">#</a></h2>
<p>Lets consider the problem of finding counterparts to a primary catalogue
(<span class="math notranslate nohighlight">\(i=1\)</span>), in our example for the X-ray source position catalogue.
Let each <span class="math notranslate nohighlight">\(N_{i}\)</span> denote the number of entries for the catalogues
used, and <span class="math notranslate nohighlight">\(\nu_{i}=N_{i}/\Omega_{i}\)</span> denote their source surface
density on the sky.</p>
<p>If a counterpart is required to exist in each of the <span class="math notranslate nohighlight">\(k\)</span>
catalogues, there are <span class="math notranslate nohighlight">\(\prod_{i=1}^{k}N_{i}\)</span> possible
associations. If we assume that a counterpart might be missing in each
of the matching catalogues, there are
<span class="math notranslate nohighlight">\(N_{1}\cdot\prod_{i=2}^{k}(N_{i}+1)\)</span> possible associations. This
minor modification, negligible for <span class="math notranslate nohighlight">\(N_{i}\gg1\)</span>, is ignored in the
following for simplicity, but handled in the code.</p>
<p>If each catalogue covers the same area with some respective, homogeneous
source density <span class="math notranslate nohighlight">\(\nu_{i}\)</span>, the probability of a chance alignment on
the sky of physically unrelated objects can then be written
(<span id="id1">Budavári and Szalay [<a class="reference internal" href="matching.html#id13" title="T. Budavári and A. S. Szalay. Probabilistic Cross-Identification of Astronomical Sources. \apj , 679:301-309, May 2008. arXiv:0707.1611, doi:10.1086/587156.">BudavariSzalay08</a>]</span>, eq. 25), as</p>
<div class="math notranslate nohighlight">
\[P(H)=N_{1}/\prod_{i=1}^{k}N_{i}=1/\prod_{i=2}^{k}N_{i}=1/\prod_{i=2}^{k}\nu_{i}\Omega_{i}.\]</div>
<p>Thus <span class="math notranslate nohighlight">\(P(H)\)</span> is the prior probability of an association. The
posterior should strongly exceed this prior probability, to avoid false
positives.</p>
<p>To account for non-uniform coverage, <span class="math notranslate nohighlight">\(P(H)\)</span> is modified by a
“prior completeness factor” <span class="math notranslate nohighlight">\(c\)</span>, which gives the expected fraction
of sources with reliable counterpart (due to only partial coverage of
the matching catalogues <span class="math notranslate nohighlight">\(\Omega_{i&gt;1}\neq\Omega_{1}\)</span>, depth of the
catalogues and/or systematic errors in the coordinates). Our prior can
thus be written as</p>
<div class="math notranslate nohighlight" id="eq-prior">
\[P(H)=c/\prod_{i=2}^{k}\nu_{i}\Omega_{1}.\label{eq:prior}\]</div>
<p>Bayes’ theorem connects the prior probability <span class="math notranslate nohighlight">\(P(H)\)</span> to the
posterior probability <span class="math notranslate nohighlight">\(P(H|D)\)</span>, by incorporating information
gained from the observation data <span class="math notranslate nohighlight">\(D\)</span> via</p>
<div class="math notranslate nohighlight" id="eq-bayes">
\[P(H|D)\propto P(H)\times P(D|H).\label{eq:bayes}\]</div>
<p>We now extend the approach of <span id="id2">Budavári and Szalay [<a class="reference internal" href="matching.html#id13" title="T. Budavári and A. S. Szalay. Probabilistic Cross-Identification of Astronomical Sources. \apj , 679:301-309, May 2008. arXiv:0707.1611, doi:10.1086/587156.">BudavariSzalay08</a>]</span>, to
allow matches where some catalogues do not participate in a match.
Comparing A12 and A14 in <span id="id3">Budavári and Szalay [<a class="reference internal" href="matching.html#id13" title="T. Budavári and A. S. Szalay. Probabilistic Cross-Identification of Astronomical Sources. \apj , 679:301-309, May 2008. arXiv:0707.1611, doi:10.1086/587156.">BudavariSzalay08</a>]</span>, assuming
that positions lie on the celestial sphere and adopting the expansions
developed in their Appendix B, we can write down likelihoods. For a
counterpart across <span class="math notranslate nohighlight">\(k\)</span> catalogues, we obtain:</p>
<div class="math notranslate nohighlight" id="eq-nwaylikelihood">
\[P(D|H)=2^{k-1}\frac{\prod\sigma_{i}^{-2}}{\sum\sigma_{i}^{-2}}\exp\left\{ -\frac{\sum_{i&lt;j}\psi_{ij}^{2}\sigma_{j}^{-2}\sigma_{i}^{-2}}{2\sum\sigma_{i}^{-2}}\right\} \label{eq:nwaylikelihood}\]</div>
<p>For a given association with participating members from <span class="math notranslate nohighlight">\(k\)</span>
catalogues, the pairwise angular separation, <span class="math notranslate nohighlight">\(\psi_{ij}\)</span>, between
catalogue <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> is judged with the relevant position
uncertainties <span class="math notranslate nohighlight">\(\sigma\)</span>. The likelihood for the hypothesis where
some catalogues do not participate in the association has the
appropriate terms in the products and sums removed. Therefore, the
likelihood is unity for the hypothesis that there is no counterpart in
any of the catalogues.</p>
<p>In comparison to our method, the method of
<span id="id4">Budavári and Szalay [<a class="reference internal" href="matching.html#id13" title="T. Budavári and A. S. Szalay. Probabilistic Cross-Identification of Astronomical Sources. \apj , 679:301-309, May 2008. arXiv:0707.1611, doi:10.1086/587156.">BudavariSzalay08</a>]</span> only compares two hypotheses for a
association: either all sources belong to the same object
(<span class="math notranslate nohighlight">\(H_{1}\)</span>), or they are coincidentally aligned (<span class="math notranslate nohighlight">\(H_{0}\)</span>). In
this computation each hypothesis test is run in isolation, and relative
match probabilities for a given source are not considered. For
completeness, we also compute the posterior of this simpler model
comparison:</p>
<div class="math notranslate nohighlight" id="eq-assocpost">
\[\begin{split}\begin{aligned}
\frac{P(H_{1}|D)}{P(H_{0}|D)} &amp; \propto &amp; \frac{P(H_{1})}{P(H_{0})}\times\frac{P(D|H_{1})}{P(D|H_{0})}\\
B &amp; = &amp; \frac{P(D|H_{1})}{P(D|H_{0})}\\
P(H_{1}|D) &amp; = &amp; \left[1+\frac{1-P(H_{1})}{B\cdot P(H_{1})}\right]^{-1}\label{eq:assocPost}
\end{aligned}\end{split}\]</div>
<p>The output column <code class="docutils literal notranslate"><span class="pre">dist_bayesfactor</span></code> stores <span class="math notranslate nohighlight">\(\log B\)</span>, while the
output column <code class="docutils literal notranslate"><span class="pre">dist_post</span></code> is the result of equation
<span class="xref std std-ref">eq-assocPost</span>. The output column <code class="docutils literal notranslate"><span class="pre">p_single</span></code> gives
<code class="docutils literal notranslate"><span class="pre">dist_post</span></code> but modified if any additional information is specified
(see Section <a class="reference external" href="sec:mag-priors">5.2</a>). As mentioned several times in
the literature, the <span id="id5">Budavári and Szalay [<a class="reference internal" href="matching.html#id13" title="T. Budavári and A. S. Szalay. Probabilistic Cross-Identification of Astronomical Sources. \apj , 679:301-309, May 2008. arXiv:0707.1611, doi:10.1086/587156.">BudavariSzalay08</a>]</span> approach does not
include sources absent in some of the catalogues, while the formulae we
develop below incorporate absent sources. This is similar in spirit to
<span id="id6">[<a class="reference internal" href="matching.html#id18" title="F.-X. Pineau, S. Derriere, C. Motch, F. J. Carrera, F. Genova, L. Michel, B. Mingo, A. Mints, A. Nebot Gómez-Morán, S. R. Rosen, and A. Ruiz Camuñas. Probabilistic multi-catalogue positional cross-match. ArXiv e-prints, September 2016. arXiv:1609.00818.">PineauDerriereMotch+16</a>]</span>, although the statistical approach is
different. We now go further and develop counterpart probabilities.</p>
<p>The first step in catalogue inference is whether the source has any
counterpart (<span class="math notranslate nohighlight">\(p_{\mathrm{any}}\)</span>). The posterior probabilities
<span class="math notranslate nohighlight">\(P(H|D)\)</span> are computed using Bayes theorem (eq.
<a class="reference external" href="eq:bayes">[eq:bayes]</a>) with the likelihood (eq.
<a class="reference external" href="eq:nwaylikelihood">[eq:nwaylikelihood]</a>) and prior (eq.
<a class="reference external" href="eq:prior">[eq:prior]</a>) appropriately adopted for the number of
catalogues the particular association draws from. For each entry in the
primary catalogue, the posteriors of all possible associations are
normalised to unity, and <span class="math notranslate nohighlight">\(P(H_{0}|D)\)</span>, the posterior probability
of the no-counterpart hypothesis, i.e., no catalogue participates,
computed. From this we compute:</p>
<div class="math notranslate nohighlight" id="eq-post-any">
\[p_{\mathrm{any}}=1-P(H_{0}|D)/\sum_{i}P(H_{i}|D)\label{eq:post-any}\]</div>
<p>If <span class="math notranslate nohighlight">\(p_{\mathrm{any}}\)</span> is low, this indicates that there is little
evidence for any of the considered, combinatorically possible
associations, except for the no-association case. The output column
<code class="docutils literal notranslate"><span class="pre">p_any</span></code> is the result of equation <a class="reference external" href="eq:post-any">[eq:post-any]</a>.</p>
<p>If <span class="math notranslate nohighlight">\(p_{\mathrm{any}}\approx1\)</span>, there is strong evidence for at
least one of the associations to another catalogue. To compute the
relative posterior probabilities of the options, we re-normalize with
the no-counterpart hypothesis, <span class="math notranslate nohighlight">\(H_{0}\)</span>, excluded:</p>
<div class="math notranslate nohighlight" id="eq-post-assoc">
\[p_{i}=P(H_{i}|D)/\sum_{i&gt;0}P(H_{i}|D)\label{eq:post-assoc}\]</div>
<p>If a particular association has a high <span class="math notranslate nohighlight">\(p_{i}\)</span>, there is strong
evidence that it is the true one, out of all present options. The output
column <code class="docutils literal notranslate"><span class="pre">p_i</span></code> is the result of equation
<a class="reference external" href="eq:post-assoc">[eq:post-assoc]</a>.</p>
<p>A “very secure” counterpart could be defined by the requirement
<span class="math notranslate nohighlight">\(p_{any}&gt;95\%\)</span> and <span class="math notranslate nohighlight">\(p_{i}&gt;95\%\)</span>, for example. However, it is
useful to run simulations to understand the rate of false positives.
Typically, much lower thresholds are acceptable.</p>
</section>
<section id="magnitudes-colors-and-other-additional-information">
<span id="sec-mag-priors"></span><h2>Magnitudes, Colors and other additional information<a class="headerlink" href="#magnitudes-colors-and-other-additional-information" title="Link to this heading">#</a></h2>
<p>Astronomical objects of various classes often show distinct color and
magnitude distributions. Because most bright X-ray point-sources in deep
images are also optically bright compared to generic sources, this
information can be exploited. Previous works
(e.g., <span id="id10">Brusa <em>et al.</em> [<a class="reference internal" href="matching.html#id11" title="M. Brusa, A. Comastri, E. Daddi, L. Pozzetti, G. Zamorani, C. Vignali, A. Cimatti, F. Fiore, M. Mignoli, P. Ciliegi, and H. J. A. Röttgering. XMM-Newton observations of Extremely Red Objects and the link with luminous, X-ray obscured quasars. \aap , 432:69-81, March 2005. arXiv:arXiv:astro-ph/0409257, doi:10.1051/0004-6361:20041468.">BrusaComastriDaddi+05</a>]</span>, ,:cite:t:<cite>Brusa2007</cite>) have modified the
likelihood ratio coming from the angular distance <span class="math notranslate nohighlight">\(f(r)\)</span>
information (likelihood ratio method,
<span id="id11">Sutherland and Saunders [<a class="reference internal" href="matching.html#id21" title="W. Sutherland and W. Saunders. On the likelihood ratio for source identification. \mnras , 259:413-420, December 1992. URL: http://adsabs.harvard.edu/cgi-bin/nph-data_query?bibcode=1992MNRAS.259..413S&amp;link_type=ARTICLE&amp;db_key=AST&amp;high=.">SutherlandSaunders92</a>]</span>) by a factor:</p>
<div class="math notranslate nohighlight">
\[LR=\frac{q(m)}{n(m)}\times f(r)\]</div>
<p>Here, <span class="math notranslate nohighlight">\(q(m)\)</span> and <span class="math notranslate nohighlight">\(n(m)\)</span> are associated with the magnitude
distributions of source (e.g. X-ray sources) and background objects
(e.g. stars, passive galaxies) respectively, but additionally contain
sky density contributions.</p>
<p>This idea can be put on solid footing within the Bayesian framework.
Here, two likelihoods are combined, by simply considering two
independent observations, namely one for the positions,
<span class="math notranslate nohighlight">\(D_{\phi}\)</span>, and one for the magnitudes <span class="math notranslate nohighlight">\(D_{m}\)</span>. The
likelihood thus becomes</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
P(D|H) &amp; = &amp; P(D_{\phi}|H)\times P(D_{m}|H)\\
 &amp; = &amp; P(D_{\phi}|H)\times\frac{\bar{q}(m)}{\bar{n}(m)},
\end{aligned}\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(\bar{q}(m)\)</span> and <span class="math notranslate nohighlight">\(\bar{n}(m)\)</span> being the probability
that a X-ray (target) source or a generic (field) source has magnitude
<span class="math notranslate nohighlight">\(m\)</span> respectively. Nwaystores the modifying factor,
<span class="math notranslate nohighlight">\(P(D_{m}|H)\)</span>, in <code class="docutils literal notranslate"><span class="pre">bias_</span></code><code class="docutils literal notranslate"><span class="pre">*</span></code> output columns, one for each
column giving a magnitude, color, or other distribution. This modifying
factor is however renormalized so that
<span class="math notranslate nohighlight">\(P(D_{m}|H)=\frac{\bar{q}(m)}{\bar{n}(m)}/\int\frac{\bar{q}(m')}{\bar{n}(m')}\bar{n}(m')dm'\)</span>,
which makes <span class="math notranslate nohighlight">\(P(D|H)=P(D_{\phi}|H)\)</span> when <span class="math notranslate nohighlight">\(m\)</span> is unknown. In
that case, <span class="math notranslate nohighlight">\(m\)</span> is marginalised over its distribution in the
general population, i.e. <span class="math notranslate nohighlight">\(\int P(D_{m}|H)\,\bar{n}(m')\,dm\)</span>. This
has the benefit that when m is unknown, the modifying factor is unity
and the probabilities remain unmodified.</p>
<p>For completeness, I mention the fully generalized case. This is attained
when an arbitrary number of photometry bands are considered, each
consisting of a magnitude measurement <span class="math notranslate nohighlight">\(m\)</span> and measurement
uncertainty <span class="math notranslate nohighlight">\(\sigma_{m}\)</span>:</p>
<div class="math notranslate nohighlight">
\[P(D_{m}|H)=\prod\frac{\int_{m}\bar{q}(m)\,p(m|D_{m})\,dm}{\int_{m}\bar{n}(m)\,p(m|D_{m})\,dm}\]</div>
<p>Here, <span class="math notranslate nohighlight">\(p(m|D_{m})\)</span> would refer to a Gaussian error distribution
with mean <span class="math notranslate nohighlight">\(m\)</span> and standard deviation <span class="math notranslate nohighlight">\(\sigma_{m}\)</span>. This is
convolved with the distribution properties. Alternatively,
<span class="math notranslate nohighlight">\(p(m|D_{m})\)</span> can also consider upper limits. However, such options
are not yet implemented in Nway. Instead, we recommend removing
magnitude values with large uncertainties (setting them to -99).</p>
</section>
<section id="auto-calibration">
<span id="sec-auto-calibration"></span><h2>Auto-calibration<a class="headerlink" href="#auto-calibration" title="Link to this heading">#</a></h2>
<p>The probability distributions <span class="math notranslate nohighlight">\(\bar{n}(m)\)</span> and <span class="math notranslate nohighlight">\(\bar{q}(m)\)</span>
can be taken from other observations by computing the magnitude
histograms of the overall population and the target sub-population (e.g.
X-ray sources).</p>
<p>Under certain approximations and assumptions, these histograms can also
be computed during the catalogue matching procedure while also being
used for the weighting. One could perform the distance-based matching
procedure laid out above, and compute a magnitude histogram of the
secure counterparts as an approximation for <span class="math notranslate nohighlight">\(\bar{q}(m)\)</span> and a
histogram of ruled out counterparts for <span class="math notranslate nohighlight">\(\bar{n}(m)\)</span>. While the
weights <span class="math notranslate nohighlight">\(\bar{q}(m)/\bar{n}(m)\)</span> may strongly influence the
probabilities of the associations for a single object, the bulk of the
associations will be dominated by distance-weighting. One may thus
assume that the <span class="math notranslate nohighlight">\(\bar{q}(m)\)</span> and <span class="math notranslate nohighlight">\(\bar{n}(m)\)</span> are computed
with and without applying the magnitude weighting are the same, which is
true in practice. When differences are noticed, they will only
strengthen <span class="math notranslate nohighlight">\(\bar{q}(m)\)</span>, and the procedure may be iterated.</p>
</section>
<section id="implementation">
<span id="sec-implementation"></span><h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<p>This section gives some details connecting the math above to
a concrete and efficient implementation on a computer.</p>
<p>The implementation for matching <span class="math notranslate nohighlight">\(n\)</span> catalogues is a Python program
called nway. The input catalogues have to be in FITS format. Information
about the (shared) sky coverage has to be provided to the program as
well. The program proceeds in four steps.</p>
<p>First, possible associations are found. It is unfeasible and unnecessary
to consider all theoretical possibilities (complexity
<span class="math notranslate nohighlight">\(O(\prod_{i=1}^{k}N_{i})\)</span>), so the sky is split first to cluster
nearby objects. For this, a hashing procedure puts each object into
HEALPix bins <span id="id12">[<a class="reference internal" href="matching.html#id14" title="K. M. Górski, E. Hivon, A. J. Banday, B. D. Wandelt, F. K. Hansen, M. Reinecke, and M. Bartelmann. HEALPix: A Framework for High-Resolution Discretization and Fast Analysis of Data Distributed on the Sphere. \apj , 622:759-771, April 2005. arXiv:arXiv:astro-ph/0409513, doi:10.1086/427976.">GorskiHivonBanday+05</a>]</span>. The bin width <span class="math notranslate nohighlight">\(w\)</span> is
chosen so that any association of distance <span class="math notranslate nohighlight">\(w\)</span> are improbable and
negligible in practice, i.e. much larger than the largest positional
error. An object with coordinates <span class="math notranslate nohighlight">\(\phi,\,\theta\)</span> is placed in the
bin corresponding to its coordinate, but also into its neighboring bins
to avoid boundary effects. This is done for each catalogue separately.
Then, in each bin, the Cartesian product across catalogues (every
possible combination of sources) is computed. All associations are
collected across the bins and filtered to be unique. The hashing
procedure adds very low effort <span class="math notranslate nohighlight">\(O(\sum_{i=1}^{k}N_{i})\)</span> while the
Cartesian product is reduced drastically to
<span class="math notranslate nohighlight">\(O(N_{\text{bins}}\cdot\prod_{i=1}^{k}\frac{N_{i}}{N_{bins}})\)</span>.
All primary objects that have no associations past this step have
<span class="math notranslate nohighlight">\(P(\text{&quot;any real association&quot;}|D)=0\)</span>.</p>
<p>The second step is the computation of posteriors using the angular
distances between counterparts. The prior is also evaluated from the
size of the catalogue and the effective coverage, as well as the
user-supplied prior incompleteness factor. The posterior for each
association based on the distances only is calculated. These posteriors
have to be modified (“correcting for unrelated associations”), to
consider associations unrelated to primary catalogue sources (described
in the paper, <span id="id13">Salvato <em>et al.</em> [<a class="reference internal" href="matching.html#id19" title="M. Salvato, J. Buchner, T. Budavári, T. Dwelly, A. Merloni, M. Brusa, A. Rau, S. Fotopoulou, and K. Nandra. Finding counterparts for all-sky X-ray surveys with NWAY: a Bayesian algorithm for cross-matching multiple catalogues. \mnras , 473:4937-4955, February 2018. arXiv:1705.10711, doi:10.1093/mnras/stx2651.">SalvatoBuchnerBudavari+18</a>]</span>, in the appendix
section “Computing all possible matches”).</p>
<p>In the third step the magnitudes are considered, and the posteriors
modified. An arbitrary number of magnitude columns in the input
catalogues can be specified. It is possible to use external magnitude
histograms (e.g. for sparse matching with few objects) as well as
computing the histograms from the data itself (see Section
<a class="reference external" href="subsec:Auto-calibration">[subsec:Auto-calibration]</a>). The breaks of
the histogram bins are computed adaptively based on the empirical
cumulative distribution found. Because the histogram bins are usually
larger than the magnitude measurement uncertainty, the latter is
currently not considered. The adaptive binning creates bin edges based
on the number of objects, and is thus independent of the chosen scale
(magnitudes, flux). Thus the method is not limited to magnitudes, but
can be used for virtually any other known object property (colours,
morphology, variability, etc.).</p>
<p>In the final step, associations are grouped by the object from the
primary catalogue (here: X-ray source catalogue). The posteriors
<span class="math notranslate nohighlight">\(p_{\mathrm{any}}\)</span> and <span class="math notranslate nohighlight">\(p_{i}\)</span> are computed. For the output
catalogue a cut on the posterior probability (e.g. above 80%) can be
applied, and all associations with their posterior probability are
written to the output fits catalogue file.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="issues.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Frequently Asked Questions</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-matching">Distance-based matching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#magnitudes-colors-and-other-additional-information">Magnitudes, Colors and other additional information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#auto-calibration">Auto-calibration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Johannes Buchner
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2013-2025, Johannes Buchner.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>